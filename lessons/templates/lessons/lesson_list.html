<!-- lesson_list.html -->
<!DOCTYPE html>
{% load static %}
<html lang="kk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∞–±–∞“õ—Ç–∞—Ä</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  
  <style>
    /* ------------------------------
       –ñ–∞–ª–ø—ã —Ñ–æ–Ω –º–µ–Ω –±–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä—ñ
    ---------------------------------*/
    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0D1117; /* Dark —Ñ–æ–Ω */
      color: #ffffff;
      min-height: 100vh; /* –≠–∫—Ä–∞–Ω–Ω—ã“£ –±–∏—ñ–∫—Ç—ñ–≥—ñ–Ω —Ç–æ–ª—Ç—ã—Ä—É */
    }

    /* –ê—Ä—Ç“õ—ã —Ñ–æ–Ω–Ω—ã“£ “Ø—Å—Ç—ñ–Ω–µ–Ω –∫—ñ—à–∫–µ–Ω–µ ”ô–π–Ω–µ–∫—à–µ (glass) —ç—Ñ—Ñ–µ–∫—Ç –±–µ—Ä—É “Ø—à—ñ–Ω */
    .lessons-wrapper {
      width: 90%;
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.06); /* –ú”©–ª–¥—ñ—Ä “õ–∞–±–∞—Ç */
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    /* –¢–∞“õ—ã—Ä—ã–ø—Ç—ã“£ ”©–∑—ñ–Ω ”ô–¥–µ–º—ñ–ª–µ—É */
    h1 {
      font-weight: 600;
      letter-spacing: 1px;
    }

    /* –ö—ñ—Ä—É/–®—ã“ì—É –±–∞—Ç—ã—Ä–º–∞–ª–∞—Ä—ã–Ω—ã“£ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ */
    .auth-buttons {
      margin-bottom: 1.5rem;
    }

    /* list-group —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä—ñ–Ω —ã“£“ì–∞–π–ª—ã –µ—Ç—É */
    .list-group {
      margin-top: 1.5rem;
      border: none;
    }

    /* –°–∞–±–∞“õ —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä—ñ–Ω—ñ“£ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ */
    .list-group-item {
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    /* –ê—à—ã“õ (“õ“±–ª—ã–ø—Å—ã–∑) —Å–∞–±–∞“õ—Ç–∞—Ä–¥—ã“£ hover-—ç—Ñ—Ñ–µ–∫—Ç—ñ—Å—ñ */
    .list-group-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-3px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* “ö“±–ª—ã–ø—Ç–∞–ª“ì–∞–Ω —Å–∞–±–∞“õ —Å—Ç–∏–ª—ñ */
    .list-group-item.locked {
      background: rgba(255, 255, 255, 0.08);
      color: #b0b0b0;
      cursor: not-allowed;
    }

    /* –°–∞–±–∞“õ –Ω”©–º—ñ—Ä—ñ–Ω—ñ“£ –¥”©“£–≥–µ–ª–µ–∫ “õ–∞–ø—Ç–∞–º–∞—Å—ã */
    .lesson-number-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      height: 40px;
      margin-right: 15px;
      border-radius: 50%;
      font-weight: 600;
      background: linear-gradient(
        135deg,
        rgba(0, 173, 255, 0.9),
        rgba(0, 99, 255, 0.9)
      );
      color: #fff;
      flex-shrink: 0;
    }

    /* –°–∞–±–∞“õ –∞—Ç–∞—É—ã */
    .lesson-title {
      font-size: 1.15rem;
      font-weight: 500;
      margin: 0;
    
      /* –ö”©–ø–∂–æ–ª–¥—ã“õ —ç–ª–ª–∏–ø—Å–∏—Å “Ø—à—ñ–Ω flex/inline-flex –µ–º–µ—Å, block –Ω–µ–º–µ—Å–µ inline-block
         —Å–∏–ø–∞—Ç—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ–ª—É—ã –∫–µ—Ä–µ–∫. –°–æ–Ω–¥–∞–π-–∞“õ display: -webkit-box; “õ–æ—Å–∞–º—ã–∑. */
      display: -webkit-box;
      -webkit-box-orient: vertical; /* –í–µ—Ä—Ç–∏–∫–∞–ª–¥—ã –±–∞“ì—ã—Ç */
      -webkit-line-clamp: 2;       /* “ö–∞–Ω—à–∞ –∂–æ–ª–¥–∞–Ω –∫–µ–π—ñ–Ω –∫–µ—Å—ñ–ª–µ—Ç—ñ–Ω—ñ–Ω –∫”©—Ä—Å–µ—Ç–µ–º—ñ–∑ */
      overflow: hidden;            /* –ê—Ä—Ç—ã“õ –º”ô—Ç—ñ–Ω –∂–∞—Å—ã—Ä—ã–ª—Å—ã–Ω */
      text-overflow: ellipsis;     /* ”ò—Ä–¥–∞–π—ã–º –±–æ–ª–º–∞—Å–∞ –¥–∞, –∫”©–ø –∂–∞“ì–¥–∞–π–¥–∞ "..." “õ–æ—é“ì–∞ —Ç—ã—Ä—ã—Å–∞–¥—ã */
    
      word-wrap: break-word;
      white-space: normal;
    }
     

    /* –ë–∞–¥–∂ —Å—Ç–∏–ª—ñ (–ö”©—Ä—É, –¢–µ—Å—Ç—Ç–µ–Ω ”©—Ç—ñ“£—ñ–∑) */
    .badge {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.4rem 0.7rem;
      border-radius: 20px;
    }

    /* "–¢–µ—Å—Ç—Ç–µ–Ω ”©—Ç—ñ“£—ñ–∑" –∂–∞–∑—É—ã–Ω –∫“Ø“£–≥—ñ—Ä—Ç—Ç–µ—É */
    .badge.bg-secondary {
      opacity: 0.7;
    }

    /* –ú–æ—Ç–∏–≤–∞—Ü–∏—è–ª—ã“õ —Ö–∞–±–∞—Ä –∞–ª—É“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∂”ô–Ω–µ –±–∞—Ç—ã—Ä–º–∞ */
    #motivational-btn {
      background: linear-gradient(135deg, #4caf50, #2e7d32);
      color: #ffffff;
      border: none;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    #motivational-btn:hover {
      background: linear-gradient(135deg, #66bb6a, #388e3c);
    }

    /* –≠–∫—Ä–∞–Ω –∫—ñ—à—ñ—Ä–µ–π–≥–µ–Ω–¥–µ (Mobile Friendly) */
    @media (max-width: 576px) {
      .lesson-number-box {
        min-width: 35px;
        height: 35px;
      }
      .lesson-title {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

  <!-- –°–∞–±–∞“õ—Ç–∞—Ä —Ç—ñ–∑—ñ–º—ñ -->
  <div class="lessons-wrapper">
    <h1 class="text-center">–°–∞–±–∞“õ—Ç–∞—Ä —Ç—ñ–∑—ñ–º—ñ</h1>
    
    <!-- –ñ“Ø–π–µ–≥–µ –∫—ñ—Ä—É / —à—ã“ì—É –±–∞—Ç—ã—Ä–º–∞–ª–∞—Ä—ã -->
    <div class="d-flex justify-content-end align-items-center auth-buttons">
      <a href="{% url 'vocabulary_list' %}" class="btn btn-success rounded-pill me-3">
        –°”©–∑–¥—ñ–∫
      </a>
      {% if user.is_authenticated %}
        <span class="me-3">
          “ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑, <strong>{{ user.username }}</strong>!
        </span>
        <form action="{% url 'logout' %}" method="post" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger rounded-pill">
            –®—ã“ì—É
          </button>
        </form>
      {% else %}
        <a href="{% url 'login' %}" class="btn btn-primary rounded-pill">
          –ö—ñ—Ä—É
        </a>
      {% endif %}
    </div>

    <!-- –°–∞–±–∞“õ—Ç–∞—Ä–¥—ã“£ —Ç—ñ–∑—ñ–º—ñ -->
    <ul class="list-group">
      {% for lesson in lessons %}
        {% if lesson.id == 1 or lesson.id in passed_lessons %}
          <!-- –ê—à—ã“õ —Å–∞–±–∞“õ (“õ“±–ª—ã–ø—Å—ã–∑) -->
          <a 
            href="{% url 'lesson_detail' lesson.id %}" 
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            style="text-decoration: none;"
          >
            <div class="d-flex align-items-center">
              <div class="lesson-number-box">{{ forloop.counter }}</div>
              <p class="lesson-title mb-0">üìñ {{ lesson.title }}</p>
            </div>
            <span class="badge bg-primary">–ö”©—Ä—É</span>
          </a>
        {% else %}
          <!-- “ö“±–ª—ã–ø—Ç–∞–ª“ì–∞–Ω —Å–∞–±–∞“õ -->
          <li class="list-group-item locked d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="lesson-number-box" style="background: #6c757d;">
                {{ forloop.counter }}
              </div>
              <p class="lesson-title mb-0">
                üîí {{ lesson.title }}
              </p>
            </div>
            <span class="badge bg-secondary">üîí –¢–µ—Å—Ç—Ç–µ–Ω ”©—Ç—ñ“£—ñ–∑</span>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>

  <!-- –ú–æ—Ç–∏–≤–∞—Ü–∏—è–ª—ã“õ —Ö–∞–±–∞—Ä–¥—ã —à—ã“ì–∞—Ä—É -->
  <div class="container text-center my-4">
    <button id="motivational-btn" class="btn btn-success rounded-pill">
      –ú–æ—Ç–∏–≤–∞—Ü–∏—è–ª—ã“õ —Ö–∞–±–∞—Ä–¥—ã –∞–ª—É
    </button>
    <div id="motivational-message" class="mt-3"></div>
  </div>

  <!-- JS –ª–æ–≥–∏–∫–∞—Å—ã -->
  <script>
    // CSRF Cookie –∞–ª—É
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach(cookie => {
          cookie = cookie.trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          }
        });
      }
      return cookieValue;
    }

    // –°–∞–±–∞“õ —Ç–µ—Å—Ç—ñ–Ω–µ–Ω ”©—Ç–∫–µ–Ω–Ω–µ–Ω –∫–µ–π—ñ–Ω –∫–µ–ª–µ—Å—ñ —Å–∞–±–∞“õ—Ç—ã –∞—à—É
    function updateLessons(nextLessonId) {
      document.querySelectorAll(".list-group-item").forEach(item => {
        const lessonNumberEl = item.querySelector(".lesson-number-box");
        if (!lessonNumberEl) return;

        const lessonNumber = parseInt(lessonNumberEl.innerText);
        const lessonTitleEl = item.querySelector(".lesson-title");

        // –ï–≥–µ—Ä “õ“±–ª—ã–ø—Ç–∞–ª“ì–∞–Ω —Å–∞–±–∞“õ—Ç—ã“£ –Ω”©–º—ñ—Ä—ñ nextLessonId –±–æ–ª—Å–∞ => –∞—à–∞–¥—ã
        if (
          lessonTitleEl && 
          lessonTitleEl.innerText.includes("üîí") && 
          lessonNumber === nextLessonId
        ) {
          item.classList.remove("locked");
          item.classList.add("list-group-item-action");
          item.style.cursor = "pointer";
          
          // –Ü—à–∫—ñ HTML-–¥—ñ —Ç–æ–ª—ã“ì—ã–º–µ–Ω –∞—É—ã—Å—Ç—ã—Ä—É
          item.innerHTML = `
            <a href="/lesson/${nextLessonId}/" 
               class="d-flex justify-content-between align-items-center text-decoration-none"
               style="color: #fff;">
              <div class="d-flex align-items-center">
                <div class="lesson-number-box">${lessonNumber}</div>
                <p class="lesson-title mb-0">${lessonTitleEl.innerText.replace("üîí", "üìñ")}</p>
              </div>
              <span class="badge bg-primary">–ö”©—Ä—É</span>
            </a>
          `;
        }
      });
    }

    // –ñ–∞—É–∞–ø—Ç—ã —Å–µ—Ä–≤–µ—Ä–≥–µ –∂—ñ–±–µ—Ä—É (–¢–µ—Å—Ç –∂–∞—É–∞–ø—Ç–∞—Ä—ã)
    function submitAnswer(questionId, answer) {
      fetch(`/submit-answer/${questionId}/`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/x-www-form-urlencoded", 
          "X-CSRFToken": getCookie('csrftoken') 
        },
        body: new URLSearchParams({ "question_id": questionId, "answer": answer })
      })
      .then(response => response.json())
      .then(data => {
        if (data.correct) {
          alert("–î“±—Ä—ã—Å –∂–∞—É–∞–ø!");
          if (data.passed && data.next_lesson) {
            updateLessons(data.next_lesson);
          }
        } else {
          alert("“ö–∞—Ç–µ –∂–∞—É–∞–ø! “ö–∞–π—Ç–∞–¥–∞–Ω –∫”©—Ä—ñ“£—ñ–∑.");
        }
      })
      .catch(error => console.error("–ñ–∞—É–∞–ø –∂—ñ–±–µ—Ä—É “õ–∞—Ç–µ—Å—ñ:", error));
    }

    // –ú–æ—Ç–∏–≤–∞—Ü–∏—è–ª—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –º–æ–¥–∞–ª –∞—Ä“õ—ã–ª—ã –∫”©—Ä—Å–µ—Ç—É
    function showMotivationalModal(message) {
      const modalHtml = `
        <div class="modal fade" id="motivationalModal" tabindex="-1" 
             aria-labelledby="motivationalModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content rounded-3" style="background: #21262D; color: #fff;">
              <div class="modal-header border-0">
                <h5 class="modal-title" id="motivationalModalLabel">
                  –ú–æ—Ç–∏–≤–∞—Ü–∏—è
                </h5>
                <button type="button" class="btn-close btn-close-white" 
                        data-bs-dismiss="modal" aria-label="–ñ–∞–±—É">
                </button>
              </div>
              <div class="modal-body">
                ${message}
              </div>
              <div class="modal-footer border-0">
                <button type="button" 
                        class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
                  –ñ–∞–±—É
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const modal = new bootstrap.Modal(document.getElementById('motivationalModal'));
      modal.show();
      document.getElementById('motivationalModal')
        .addEventListener('hidden.bs.modal', function () {
          this.remove();
        });
    }

    // –ú–æ—Ç–∏–≤–∞—Ü–∏—è–ª—ã“õ —Ö–∞–±–∞—Ä–¥—ã –±–∞—Ç—ã—Ä–º–∞ –∞—Ä“õ—ã–ª—ã –∞–ª—É
    document.getElementById("motivational-btn").addEventListener("click", function () {
      const csrfToken = getCookie('csrftoken');
      fetch("/motivational-message/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken
        },
        body: new URLSearchParams({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          document.getElementById("motivational-message").innerHTML = 
            `<div class="alert alert-danger">${data.error}</div>`;
        } else {
          // –ú–æ–¥–∞–ª –∞—Ä“õ—ã–ª—ã –∫”©—Ä—Å–µ—Ç—É
          showMotivationalModal(data.message);
        }
      })
      .catch(error => {
        console.error("“ö–∞—Ç–µ:", error);
        document.getElementById("motivational-message").innerHTML = 
          `<div class="alert alert-danger">“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã.</div>`;
      });
    });
  </script>

  <!-- Bootstrap JS (Modal –∂”ô–Ω–µ —Ç.–±. “Ø—à—ñ–Ω) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
  </script>
</body>
</html>
